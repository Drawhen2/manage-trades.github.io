<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR SeaBank</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; background-color: #000; 
            font-family: 'Inter', sans-serif; color: white;
            height: 100vh; display: flex; flex-direction: column;
        }

        /* Header */
        .header {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 20px; z-index: 100; display: flex; 
            align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
        }
        .back-btn { 
            color: white; text-decoration: none; font-size: 24px; 
            margin-right: 15px; cursor: pointer;
        }

        /* Scanner Area */
        #reader { 
            width: 100% !important; height: 100vh !important; 
            border: none !important;
        }
        #reader video { 
            object-fit: cover !important; 
        }

        /* UI Overlay */
        .overlay-ui {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 30px 20px; color: #333; z-index: 101; text-align: center;
        }
        .instruction { font-size: 16px; font-weight: 600; margin-bottom: 20px; }
        
        .upload-section {
            border: 2px dashed #FA6400; background: #FFF5EE;
            padding: 15px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }
        .upload-section span { color: #FA6400; font-size: 14px; margin-top: 5px; font-weight: 500; }
        
        /* Hide default library buttons */
        #reader__dashboard_section_csr button {
            background-color: #FA6400 !important; color: white !important;
            border: none !important; padding: 10px 20px !important;
            border-radius: 8px !important; text-transform: uppercase;
            font-weight: bold; margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn">‚úï</a>
        <span style="font-weight: 600;">Scan QR</span>
    </div>

    <div id="reader"></div>

    <div class="overlay-ui">
        <div class="instruction">Scan Kode QR atau Upload Gambar</div>
        
        <label for="qr-input-file" class="upload-section">
            <span style="font-size: 24px;">üñºÔ∏è</span>
            <span>Pilih dari Galeri / Upload Foto</span>
            <input type="file" id="qr-input-file" accept="image/*" style="display:none">
        </label>

        <p id="error-msg" style="color: red; font-size: 12px; margin-top: 10px; display: none;">
            Kamera tidak terdeteksi. Silakan gunakan fitur Upload Gambar.
        </p>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const fileInput = document.getElementById('qr-input-file');

        // 1. Fungsi Sukses Scan
        function handleSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                if(data.amount) {
                    html5QrCode.stop().then(() => {
                        window.location.href = `payment.html?amount=${data.amount}&name=${data.name}`;
                    }).catch(() => {
                        window.location.href = `payment.html?amount=${data.amount}&name=${data.name}`;
                    });
                } else {
                    alert("QR Code bukan format SeaBank!");
                }
            } catch (e) {
                alert("QR tidak dikenali: " + decodedText);
            }
        }

        // 2. Memulai Kamera Otomatis
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            handleSuccess
        ).catch(err => {
            console.error("Gagal kamera:", err);
            document.getElementById('error-msg').style.display = 'block';
        });

        // 3. Fitur Upload Gambar (Jika Kamera Gagal)
        fileInput.addEventListener('change', e => {
            if (e.target.files.length == 0) return;
            const imageFile = e.target.files[0];
            
            html5QrCode.scanFile(imageFile, true)
                .then(decodedText => {
                    handleSuccess(decodedText);
                })
                .catch(err => {
                    alert("Gagal membaca QR dari gambar. Pastikan gambar jelas.");
                });
        });
    </script>
</body>
</html>
